// Code executed on 'host' page to load the embed iframe.

(function() {

  var getUrlParameter = function(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
  };


  var self_script_tag = document.querySelector("script[src='<%= search_embed_url(format: :js) %>']");

  if (! self_script_tag) {
    console.log("search_form_embed.js couldn't find self_script_tag");
    return;
  }


  var iFrameUrl = '<%= search_embed_url(format: :html) %>?';
  ['search.focus', 'search.type'].forEach(function(key){
    var value = getUrlParameter(key);
    if(value) {
      iFrameUrl += key + "=" + value + "&";
    }
  });

  var iFrame   = document.createElement("iframe");
  iFrame.src   = iFrameUrl;
  iFrame.style.border = 'none';
  iFrame.style.width = '100%';
  iFrame.style.height = "74px";
  iFrame.scrolling = "no";

  window.addEventListener('message', function(event) {
    if (event.data && event.data.embedFormHeight) {
      iFrame.style.height = event.data.embedFormHeight + "px";
    }
  });

  self_script_tag.parentElement.insertBefore(iFrame, self_script_tag);

})();
